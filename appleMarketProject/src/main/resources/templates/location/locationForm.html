<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{template/client/layout/layout}">
<th:block layout:fragment="css">
	<link rel="stylesheet" href="/css/location/location.css" />
</th:block>
<th:block layout:fragment="content">
	<div id="map"></div>
	<div class="locationInfo">
		<p>ì´ ë™ë„¤ê°€ ë§ë‚˜ìš”?ğŸ˜€</p>
	</div>
	<div class="locationInfo">
		<span id="locationName"></span>
		<button type="button" id="locationConfirmBtn" class="btn btn-primary">í™•ì¸</button>
	</div>
	<p>ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ì‹œë©´ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.</p>
	<div class="d-flex locationSearch ">
		<input type="text" class="form-control md-3" id="sample5_address" placeholder="ë™ ì´ë¦„ ì…ë ¥ ì˜ˆ)ì—­ì‚¼ë™ " /> 
		<input type="button" class="ml-3" onclick="searchByDongName()" value="ì£¼ì†Œ ê²€ìƒ‰" />
		<div id="pocket"></div>
	</div>
</th:block>

<th:block layout:fragment="script">
	<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=4570eb39c301bafd74fdfcb2e3d0818a&libraries=services"></script>
	<script>
		var mapContainer = document.getElementById('map'),
		mapOption = {
			center: new kakao.maps.LatLng(33.450701, 126.570667),
			level: 3
		};

		var map = new kakao.maps.Map(mapContainer, mapOption);
		var marker = new kakao.maps.Marker({
			map: map,
			position: mapOption.center
		});

		var locationNameConfirm = document.getElementById("locationName");
		var infowindow = new kakao.maps.InfoWindow({zIndex: 1});
		var geocoder = new kakao.maps.services.Geocoder();
		var locationID = null;

		// HTML5ì˜ geolocationìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤ 
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var lat = position.coords.latitude,
					lon = position.coords.longitude;

				var locPosition = new kakao.maps.LatLng(lat, lon),
					message = '<div style="padding:5px;">ì—¬ê¸°ì— ê³„ì‹ ê°€ìš”?!</div>';

				displayMarker(locPosition, message);
			});
		} else {
			var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),
				message = 'ìœ„ì¹˜ ì •ë³´ê°€ í™•ì¸ë˜ì§€ ì•Šì•„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.';
			displayMarker(locPosition, message);
		}

		function displayMarker(locPosition, message) {
			marker.setPosition(locPosition);
			map.setCenter(locPosition);

			var iwContent = message;
			infowindow.setContent(iwContent);
			infowindow.open(map, marker);

			searchAddrFromCoords(locPosition, function(result, status) {
				if (status === kakao.maps.services.Status.OK) {
					var detailAddr = '';
					locationID = result[0].code;  // ì—¬ê¸°ì„œ codeë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

					console.log('Location ID (í–‰ì •ë™ ì½”ë“œ):', locationID);

					for (var i = 0; i < result.length; i++) {
						if (result[i].region_type === 'H') {
							detailAddr = result[i].address_name;
							break;
						}
					}
					locationNameConfirm.textContent = detailAddr;
				}
			});
		}

		function searchByDongName() {
			var dongName = document.getElementById('sample5_address').value;
			if (dongName.trim() === "") {
				alert("ë™ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			
			// ë™ ì´ë¦„ì„ ê¸°ë°˜ìœ¼ë¡œ ì£¼ì†Œ ê²€ìƒ‰
			geocoder.addressSearch(dongName, function(results, status) {
				if (status === kakao.maps.services.Status.OK) {
					var result = results[0]; // ê²€ìƒ‰ëœ ê²°ê³¼ì˜ ì²« ë²ˆì§¸ í•­ëª© ì‚¬ìš©
					var coords = new kakao.maps.LatLng(result.y, result.x);

					// ì§€ë„ ì¤‘ì‹¬ì„ ê²€ìƒ‰ëœ ìœ„ì¹˜ë¡œ ì´ë™
					map.setCenter(coords);
					marker.setPosition(coords);

					// í–‰ì •ë™ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
					searchAddrFromCoords(coords, function(regionResult, regionStatus) {
						if (regionStatus === kakao.maps.services.Status.OK) {
							locationID = regionResult[0].code;  // í–‰ì •ë™ ì½”ë“œ ì—…ë°ì´íŠ¸
							console.log('Location ID (í–‰ì •ë™ ì½”ë“œ):', locationID);

							var detailAddr = '';
							for (var i = 0; i < regionResult.length; i++) {
								if (regionResult[i].region_type === 'H') {
									detailAddr = regionResult[i].address_name;
									break;
								}
							}
							var content = '<div class="bAddr">' +
								'<span class="title">ë™ ì´ë¦„ : </span>' + detailAddr + '</div>';
							infowindow.setContent(content);
							infowindow.open(map, marker);
							locationNameConfirm.textContent = detailAddr;
						}
					});
				} else {
					alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
				}
			});
		}

		document.getElementById("locationConfirmBtn").addEventListener("click", function() {
			if (locationID !== null) {
				$.ajax({
					url: '/user/updateLocation',
					method: 'post',
					data: JSON.stringify({
						locationID: locationID
					}),
					contentType: "application/json",
					success: function(response) {
						console.log("ì„œë²„ ì‘ë‹µ : ", response);
					},
					error: function(error) {
						console.log("ì—ëŸ¬ ë°œìƒ : ", error);
					}
				});
			} else {
				alert("ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
			}
		});

		function searchAddrFromCoords(coords, callback) {
			geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);
		}

		function searchDetailAddrFromCoords(coords, callback) {
			geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
		}
	</script>
</th:block>
</html>
